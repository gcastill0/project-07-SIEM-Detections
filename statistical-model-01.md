## Introduction

This search identifies users whose outbound network activity is statistically disproportionate compared to the rest of the environment. It models each user’s share of total outbound traffic over time, establishes a behavioral baseline using mean and standard deviation, and then applies a Z-score to highlight users whose traffic contribution deviates significantly from their normal pattern—an approach well suited for detecting anomalous data exfiltration, misuse, or compromised accounts.

```sql
| join 
USER_VOLUME = (
  dataSource.name = 'SentinelOne' 
  event.category='ip' event.network.direction='OUTGOING' 
  | filter NOT ( dst.ip.address in ( 
    '192.168.',
    '10.2'
  )) 
  | let traffic.bytes_out = number(src.process.image.size)
  | group user_volume_per_tp = sum(traffic.bytes_out), 
    total_average_per_tp = average(traffic.bytes_out) by src.process.parent.user, 
    timestamp = timebucket('1h') 
  | filter NOT (isempty(src.process.parent.user))
),
TRAFFIC_VOLUME = (
  dataSource.name = 'SentinelOne' 
  event.category='ip' event.network.direction='OUTGOING' 
  | filter NOT ( dst.ip.address in ( 
    '192.168.',
    '10.2'
  )) 
  | let traffic.bytes_out = number(src.process.image.size)
  | group total_volume_per_tp = sum(traffic.bytes_out), 
    average_volume_per_tp = avg(traffic.bytes_out) by timestamp = timebucket('1h')
) on timestamp
| let RATIO = user_volume_per_tp / total_volume_per_tp
| group 
    U = sum(user_volume_per_tp), 
    N = sum(total_volume_per_tp), 
    MU = avg(RATIO), 
    SIGMA = stddev(RATIO) 
    by src.process.parent.user, timestamp = timebucket()
| let R = U / N
| let Z_SCORE = abs(( R - MU ) / SIGMA)
```

---

Below is the same logic expressed **purely in mathematical terms**, independent of any log or query language.

### Definitions (per hour ( t ))

Let:

* ( b_{u,t} ) = outbound “bytes” attributed to **user ( u )** during hour ( t )
* ( B_t = \sum_{u} b_{u,t} ) = **total outbound bytes** across all users during hour ( t )

### Step 1: User share of total traffic (per hour)

For each user ( u ) and hour ( t ):

[
r_{u,t} = \frac{b_{u,t}}{B_t}
]

This is the **fraction of total outbound traffic** generated by user ( u ) in hour ( t ).

### Step 2: Baseline statistics for each user

Over a window of ( T ) hours (the grouped time window):

### Mean (expected share)

[
\mu_u = \frac{1}{T} \sum_{t=1}^{T} r_{u,t}
]

### Standard deviation (variability of share)

[
\sigma_u = \sqrt{ \frac{1}{T} \sum_{t=1}^{T} (r_{u,t} - \mu_u)^2 }
]

### Step 3: Aggregate share over the window

Total user traffic over the window:

[
U_u = \sum_{t=1}^{T} b_{u,t}
]

Total traffic over the window:

[
N = \sum_{t=1}^{T} B_t
]

User’s overall share for the window:

[
R_u = \frac{U_u}{N}
]

### Step 4: Z-score (degree of anomaly)

[
Z_u = \left| \frac{R_u - \mu_u}{\sigma_u} \right|
]

## Interpretation

* ( Z_u \approx 0 ): user behavior is normal
* ( Z_u \approx 2 ): unusual but plausible
* ( Z_u \ge 3 ): statistically significant anomaly

This models **relative outbound dominance**, not absolute volume.
A user triggers when their **share of total traffic** deviates sharply from their historical baseline.

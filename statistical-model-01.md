## Introduction

This search identifies users whose outbound network activity is statistically disproportionate compared to the rest of the environment. It models each user’s share of total outbound traffic over time, establishes a behavioral baseline using mean and standard deviation, and then applies a Z-score to highlight users whose traffic contribution deviates significantly from their normal pattern—an approach well suited for detecting anomalous data exfiltration, misuse, or compromised accounts.

```sql
| join 
USER_VOLUME = (
  dataSource.name = 'SentinelOne' 
  event.category='ip' event.network.direction='OUTGOING' 
  | filter NOT ( dst.ip.address in ( 
    '192.168.',
    '10.2'
  )) 
  | let traffic.bytes_out = number(src.process.image.size)
  | group user_volume_per_tp = sum(traffic.bytes_out), 
    total_average_per_tp = average(traffic.bytes_out) by src.process.parent.user, 
    timestamp = timebucket('1h') 
  | filter NOT (isempty(src.process.parent.user))
),
TRAFFIC_VOLUME = (
  dataSource.name = 'SentinelOne' 
  event.category='ip' event.network.direction='OUTGOING' 
  | filter NOT ( dst.ip.address in ( 
    '192.168.',
    '10.2'
  )) 
  | let traffic.bytes_out = number(src.process.image.size)
  | group total_volume_per_tp = sum(traffic.bytes_out), 
    average_volume_per_tp = avg(traffic.bytes_out) by timestamp = timebucket('1h')
) on timestamp
| let RATIO = user_volume_per_tp / total_volume_per_tp
| group 
    U = sum(user_volume_per_tp), 
    N = sum(total_volume_per_tp), 
    MU = avg(RATIO), 
    SIGMA = stddev(RATIO) 
    by src.process.parent.user, timestamp = timebucket()
| let R = U / N
| let Z_SCORE = abs(( R - MU ) / SIGMA)
```

---

## Mathematical Model Overview

This detection models **relative outbound traffic dominance** per user and applies statistical anomaly detection to identify abnormal behavior.


### Definitions (per time period \( t \))

For a user **u** and time period **t**:

$$
b_{u,t} = \text{outbound volume generated by user } u \text{ at time } t
$$

$$
B_t = \text{total outbound volume across all users at time } t
$$



### User Share of Traffic

For each user \( u \) at time \( t \):

$$
r_{u,t} = \frac{b_{u,t}}{B_t}
$$


This represents the **fraction of total outbound traffic** generated by user \( u \).


### Baseline Statistics (per user)

Over a window of \( T \) periods:

> **Mean share**

$$
\mu_u = \frac{1}{T} \sum_{t=1}^{T} r_{u,t}
$$

> **Standard deviation**

$$
\sigma_u = \sqrt{\frac{1}{T} \sum_{t=1}^{T} (r_{u,t} - \mu_u)^2}
$$

### Aggregate Share Over the Window

> **Total user volume**

$$
U_u = \sum_{t=1}^{T} b_{u,t}
$$

> **Total environment volume**

$$
N = \sum_{t=1}^{T} B_t
$$

> **User’s aggregate share**

$$
R_u = \frac{U_u}{N}
$$

### Anomaly Score (Z-score)

$$
Z_u = \left| \frac{R_u - \mu_u}{\sigma_u} \right|
$$

---

## Interpretation

| Condition | Meaning |
|---------|---------|
| Z(u) ≈ 0 | Normal behavior |
| Z(u) ≈ 2 | Moderately unusual |
| Z(u) ≥ 3 | Statistically significant anomaly |
